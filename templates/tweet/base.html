{% load static %}
<!DOCTYPE html5>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>t-clone</title>
        <!-- cdnはbase.htmlに読み込む -->
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    </head>
    <body>
        <header>
            <a href="/">TOP</a>
            <a href="about">このサイトについて</a>
        </header>
        <main>
            <div id="app">
                <div>
                    <textarea v-model="tweetContent" placeholder="いまなにしてる？" v-on:keyup="switchDisabled"></textarea>
                    <input id="tweetBuuton" type="button" value="ツイート" v-on:click="postTweet" disabled="True">
                </div>
                <div v-for="tweet in tweets">
                    <div class="tweet">
                        <p><span class="author">[[ tweet.author ]]</span><span class="date_posted">[[ tweet.date_posted ]]</span></p>
                        <div>[[ tweet.content ]]</div>
                        <div>
                            <input type="button" class="likeButton" value="いいね" v-on:click="addLikeCount(tweet.id)"><span>[[ tweet.likes ]]</span>
                            <input type="button" value="ツイートを削除" v-on:click="deleteTweet(tweet.id)"><span>
                        </div>
                    </div>
                </div>
            </div>
            {% comment %}index.htmlの{% block content %}{% endblock content %}で囲まれた要素が挿入される{% endcomment %}
            {% block content %}{% endblock content %}
        </main>
        <script>
            var app = new Vue({
                delimiters: ["[[", "]]"], /* {変数名}だとdjangoの表記と被るので[[変数名]]に変更する */
                el: "#app",
                data: {
                    tweetContent: "",
                    tweets: [],
                },
                methods: {
                    /* bodyにv-on:loadだと実行されなかった */
                    window:onload = function() {
                        app.getTweet();
                    },
                    /* onloadの中には書かず別々にしておく */
                    getTweet: function() {
                        fetch("/get")
                        .then((res) => res.json())
                        .then((res) => app.tweets = app.tweets.concat(JSON.parse(res.tweets)))
                        .catch((err) => alert(err));
                    },
                    switchDisabled: function() {
                        if (app.tweetContent.length == 0) {
                            document.getElementById("tweetBuuton").disabled = "true";
                        } else { 
                            document.getElementById("tweetBuuton").removeAttribute("disabled");
                        }
                    },
                    postTweet: function() {
                        var newPost = {"content": app.tweetContent, "author": "bot", "date_posted": new Date(), "likes": 0}
                        var opt = {
                            "method": "post", 
                            "headers": {"Content-Type": "application/json", "X-CSRFToken": document.cookie.split("=")[1]},
                            "body": JSON.stringify(newPost)
                        };
                        fetch("/post", opt)
                        .then((res) => res.json())
                        .then((res) => {
                            newPost.id = res.id
                            app.tweets = app.tweets.concat(newPost);
                            alert(app.tweets)
                            app.tweetContent = "";
                        })
                        .catch((err) => alert(err));
                    },
                    addLikeCount: function(id) {
                        var opt = {
                            "method": "post", 
                            "headers": {"Content-Type": "application/json", "X-CSRFToken": document.cookie.split("=")[1]},
                            /* idは1から始まるのでhtml上では-1する */
                            "body": JSON.stringify({"id": id, "likes": app.tweets[id - 1].likes})
                        };
                        fetch("/like", opt)
                        .then((res) => res.json())
                        .then((res) => {
                            /* 別のツイートがいねされたりエラーになったりする */
                            var index = app.tweets.indexOf(app.tweets.map(function(tweet) { return tweet.id }));
                            alert(app.tweets.map(function(tweet) { return tweet.id }))
                            //app.tweets[index].likes += 1;
                        })
                        .catch((err) => alert(err));
                    },
                    deleteTweet: function(id) {
                        var opt = {
                            "method": "post", 
                            "headers": {"Content-Type": "application/json", "X-CSRFToken": document.cookie.split("=")[1]},
                            /* idは1から始まるのでhtml上では-1する */
                            "body": JSON.stringify({"id": id})
                        };
                        fetch("/delete", opt)
                        .then((res) => res.json())
                        .then((res) => {
                            app.tweets = app.tweets.filter(function(tweet) { return tweet.id != id });
                            alert("ツイートを削除しました");
                        })
                        .catch((err) => alert(err));
                    }
                }
            });
        </script>
        <style>
            body {
                background: #DDDDDD;
            }
            header {
                margin-bottom: 20px;
            }
            #tweetBuuton {
                color: white;
                background: orange;
                border: none;
                border-radius: 10px;
            }
            .tweet {
                background: white;
                border: ridge;
            }
            .author {
                margin-right: 10px;
            }
            .like {

            }
        </style>
    </body>
</html>